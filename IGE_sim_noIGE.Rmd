---
title: 'Genetic Nurturing Effects: Simulations w/o IGE'
author: "Melisa Chuong"
date: "03/02/2021"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# SIMULATION ANALYSES {.tabset}  

Simulations were conducted to explore how results of the pathway models outlined above differed using PGSs with varying levels of predictive ability. 10,000 trio members with respective genetic, phenotypic and PGS variables were simulated. 

## SIMULATING TRIO FAMILIES

Simulations were conducted to explore how results of the pathway models outlined above differed using PGSs with varying levels of predictive ability. 10,000 trio members with respective genetic, phenotypic and PGS variables were simulated. The aim here is to simulate the genetic and phenotypic associations between members of a trio i.e. biological parents and a single offspring. To keep analyses simple and efficient we simulate the trio effects in variances rather than simulating individual genotypes. Transmitted and non-transmitted genetic variances **are not** separated in these simulations.  

I aim to simulate these variables as they would occur in real life where possible, within the constraints of choosing to simulate focusing on variances rather than individual genotypes. Please read the comments within the code for clarity.  

A dataframe with trio phenotypes and respective trio genetics and PRSs is generated. This will then go on to be used in subsequent regression and pathway analyses.  

**What do we simulate**  

Simulated phenotypic variables had a variance of 1. Additive genetic variance was computed as the heritability multiplied by the phenotypic variance. Genetic variance was represented as two separate entities; tagged genetic variance, aiming to capture variance attributable to genotyped variants, and non-tagged genetic variance, aiming to capture variance attributable to non-genotyped variants. The tagged genetic variance was calculated as the additive genetic variance multiplied by a pre-specified value, resulting in the desired tagged genetic variance (this can also be thought of as SNP heritability when using real data). Non-tagged genetic variance would be the remaining genetic variance and was calculated as the difference between the additive genetic variance and tagged genetic variance. All remaining variance was attributed to environmental variance, calculated as the product of the phenotypic variance and the difference between one and the specified heritability value. An additional noise variance was specified aiming to capture inaccuracies/biases in variant beta effect sizes specified in GWAS due to the lack of statistical power, which go onto add noise to PGSs. This noise variance was assigned values starting from zero, with zero representing completely accurate beta effect sizes from GWAS.   

The parental genetic variables were constructed as the sum of tagged and non-tagged genetic counterparts. Tagged genetic variable values were simulated from a normal distribution with a mean of zero, and standard deviation of the square root of the tagged genetic variance (explained above). Similarly, non-tagged genetic variable values were simulated from a normal distribution with a mean of zero, and a standard deviation of the square root of non-tagged genetic variance. 
Similarly, the offspring genetic variables were constructed as the sum of tagged and non-tagged genetic counterparts. Offspring tagged and non-tagged genetic variables were simulated as the average of the summed respective tagged and non-tagged maternal and paternal genetic variables, with the addition of a respective tagged and non-tagged segregation variable aiming to capture variability that occurs from random segregation of genes observed during meiosis (Yanowitz, 2010). The tagged and non-tagged segregation variable values were simulated from a normal distribution with a mean of zero and standard deviation of the square root of half the tagged and non-tagged genetic variance, respectively. 
Separate environmental variables were constructed for each member of the trio. This variables were simulated from a normal distribution with a mean of zero, and a standard deviation of the square root of the environmental variance.
The phenotypic variables for each member of the trio was then constructed as the sum of the respective trio member’s genetic and environmental variable values.
  

Polygenic score variables were derived from the trio member's respective tagged genetic component, as PGSs can only be derived using genotyped variants when using real data. The PGSs also included a noise term aiming to represent noise that can arise from GWAS lacking power, resulting in beta estimates (effect sizes) of each variant being potentially inaccurate/biased. Parental noise variables were simulated from a normal distribution with a mean of zero, and a standard deviation of the square root of the noise variance (specified above). Maternal and paternal PGSs were subsequently calculated as the sum of the respective tagged genetic and noise variables. 
The noise component for the offspring PGSs was calculated as the average of the parental noise variables in order to capture noise correlation seen within families; as it is likely that families share a greater number of genetic variants, thus, sharing a greater number of variants with potentially biased estimates within their PGSs than with non-related individuals. Moreover, offspring PGSs further capture an independent noise component, simulated from a normal distribution with a mean of zero, and a standard deviation of the square root of half of the pre-specified noise variance. Thus, the offspring PGSs were calculated as the sum of the offspring tagged genetic, the average of the parental noise variables and the offspring’s independent noise variables.

Different scenarios, with 15 replications each, were conducted with a range of plausible trait heritabilities (0.3, 0.6, 0.9), proportion of tagged genetic variances (0.2, 0.6, 1) and polygenic score noise (0-1, by 0.1 increments) in order for the findings to have broad applicability to the study of a wide variety of traits/complex trait architectures.   

First I will write a function to create the dataframes which will be named *cohort*. Separate dataframes for each specified scenario will be created with 15 replications.  

```{r data_sim}

  ##########################################################################
  #1. Coding a function that returns the simulated variables in a dataframe#
  ##########################################################################
  
  RNGkind("L'Ecuyer-CMRG")
  set.seed(14) #14 is my lucky number

  sim <- function(h2, tagged, prs_noise, cor_AM) {
  
  V_P <- 1 #phenotypic variance is = 1
  cov_AM <- cor_AM * V_P # parental phenotypic covariance from assortative mating
  Sigma_P <- matrix(c(V_P, cov_AM, cov_AM, V_P), nrow = 2) # parental phenotypic covariance
  Sigma_A <- h2*Sigma_P #the heritability is equal to the additive genetic variance
  Sigma_Tagged <- tagged*Sigma_A #the value of tagged should be SNP heritability i.e. the proportion of the genetic variance that is actually tagged by measured variants
  Sigma_nTagged <- Sigma_A - Sigma_Tagged
  Sigma_E <- (1-h2)*Sigma_P #the environmental variance
  n <- 10000 # simulating 10,000 trios
  
  #Creating a parental genetic variables that captures ALL tagged genetic variance
  parental_genetic_tagged = MASS::mvrnorm(n, mu=c(0, 0), Sigma = Sigma_Tagged)
  maternal_genetic_tagged = parental_genetic_tagged[,1]
  paternal_genetic_tagged = parental_genetic_tagged[,2]
  
  #Creating a parental genetic variable that captures ALL non-tagged genetic variance 
  parental_genetic_ntagged = MASS::mvrnorm(n, mu=c(0, 0), Sigma = Sigma_nTagged)
  maternal_genetic_ntagged = parental_genetic_ntagged[,1]
  paternal_genetic_ntagged = parental_genetic_ntagged[,2]
  
  #Creating a parental genetic variables that is the sum of the tagged and non-tagged genetic variance
  maternal_genetic = maternal_genetic_tagged + maternal_genetic_ntagged
  paternal_genetic = paternal_genetic_tagged + paternal_genetic_ntagged
  
  #Creating parental environmental variables that capture the environmental variance
  parental_environment = MASS::mvrnorm(n, mu=c(0, 0), Sigma = Sigma_E)
  maternal_environment = parental_environment[,1]
  paternal_environment = parental_environment[,2]
  
  #Creating parental phenotypic variables that is made up of both genetic and environmental variance
  maternal_phenotype = maternal_genetic + maternal_environment
  paternal_phenotype = paternal_genetic + paternal_environment
  
  #offspring segregation is generated to capture noise that occurs from genetic segregation
  #separate segregation terms are generated using tagged and non-tagged genetic variance
  offspring_segregation_tagged = rnorm(n, 0, sd=sqrt(Sigma_Tagged[1,1]/2))
  offspring_segregation_ntagged = rnorm(n, 0, sd=sqrt(Sigma_nTagged[1,1]/2))
  
  #separate offspring genetic counterparts are created using tagged and non-tagged genetic variance (including segregation variance) from each parent
  offspring_genetic_tagged = (maternal_genetic_tagged + paternal_genetic_tagged)/2 + offspring_segregation_tagged
  offspring_genetic_ntagged = (maternal_genetic_ntagged + paternal_genetic_ntagged)/2 + offspring_segregation_ntagged
  
  #final offspring genetic variable is created by summing the offspring genetic counterparts generated above
  offspring_genetic = offspring_genetic_tagged + offspring_genetic_ntagged
  
  #offspring environmental variable made up of environmental variance
  offspring_environment <- rnorm(n, mean=0, sd = sqrt(Sigma_E[1,1]))
  
  #offspring phenotypic variable is the sum of the offspring genetic and environmental variables 
  offspring_phenotype <- offspring_genetic + offspring_environment
  
  #creating PRSs 
  #PRSs, especially for psychiatric traits, are still poor measures of genetic variance due to two main reasons 
  #1) the amount of genetic variants measured (tagged genetic variance) is still very low - we capture this in our simulations with our varying tagged parameter
  #2) the estimates of the variant effect on the phenotype may not be accurate i.e. GWAS are still quite underpowered - we capture this with our varying V_noise parameter
  #Remember that the PRSs are purely derived from tagged genetic variance 
  V_noise = prs_noise
  Sigma_noise <- matrix(c(V_noise, cor_AM * V_noise,
                          cor_AM * V_noise, V_noise), nrow = 2) # parental noise covariance
  
  #Creating parental PRSs where PRSs are derived of parental tagged genetic variables + noise derived using the noise variance variable created in the previous step
  parental_noise <- MASS::mvrnorm(n, mu = c(0, 0), Sigma = Sigma_noise)
  maternal_noise = parental_noise[,1]
  paternal_noise = parental_noise[,2]
  
  maternal_prs = maternal_genetic_tagged + maternal_noise
  paternal_prs = paternal_genetic_tagged + paternal_noise 
  
  
  #Simulating offspring PRSs derived from offspring tagged genetic variable + noise derived from the average parental noise and offspring noise
  offspring_prs = offspring_genetic_tagged + rnorm(n, 0, sd=sqrt(V_noise/2)) + (maternal_noise + paternal_noise)/2
  
  
  #Creating a data.frame with all important variables included
  cohort <- data.frame(maternal_genetic, maternal_environment, maternal_phenotype, maternal_prs,
                       paternal_genetic, paternal_environment, paternal_phenotype, paternal_prs,
                       offspring_genetic, offspring_environment, offspring_phenotype, offspring_prs)
  return(cohort)}

```


## ANALYSES USING SIMULATED DATASETS {.tabset}  

### Regression Simulations  

```{r sim_regression}
sim_regression <- function(cohort) {
    regression <- summary(lm(offspring_phenotype ~ offspring_prs + maternal_prs + paternal_prs + maternal_phenotype + paternal_phenotype , data=cohort))
    return(regression[c('coefficients', 'adj.r.squared')])
}
 # colnames(final) <- c("Predictor", "Estimate", "SE", "T-value", "P-value", "AdjR2", "prs_noise", "replica", "h2", "Tagged")
 # write.table(final, "sim_noIGE_trioprs_parentpheno.txt", col.names=F, row.names=F, quote=F, append=T) 
```

### Pathway Model Simulations  

```{r sim_path}

library(lavaan)

sim_path <- function(model, cohort) {
  fitM <- sem(model, data=cohort, estimator='ML')
  
  sem_model <- summary(fitM, standardized=TRUE, fit.measures=TRUE, ci=TRUE)
  
  return(list(pe = sem_model$pe, AIC = AIC(fitM)))
  # sem_model_df <- as.matrix(sem_model$pe)
  # sem_model_final <- sem_model_df[sem_model_df[,4] != "", c(1,3:4,6,7,9:11)]
  # simple_model <- cbind(sem_model_final, AIC(fitM), replica, cohort$h2, cohort$tagged, cohort$prs_noise)
  # colnames(final) <- c("DV", "IV", "label", "Estimate", "SE", "P-value", "lowerCI", "upperCI", "AIC", "replica", "h2", "Tagged", "prs_noise")
}

      ##############
      #SIMPLE MODEL#
      ##############
      
      simple_model <- ' 
      
      #direct effects
      offspring_phenotype ~ c*maternal_prs
      offspring_phenotype ~ b*paternal_prs            
      
      #mediator
      offspring_prs ~ i*maternal_prs
      offspring_prs ~ h*paternal_prs
      offspring_phenotype ~ a*offspring_prs
      
      # indirect effects (i*a, h*a)
      ia := i*a
      ha := h*a
      
      # total effects 
      total_mum := c + (i*a)
      total_dad := b + (h*a)
      '
      
      ################
      #EXTENDED MODEL#
      ################
        
      extended_model <- '

      #direct effects
      offspring_phenotype ~ c*maternal_prs
      offspring_phenotype ~ b*paternal_prs        

      #mediator
      offspring_prs ~ i*maternal_prs
      offspring_prs ~ h*paternal_prs 
      offspring_phenotype ~ a*offspring_prs
      paternal_phenotype ~ d*paternal_prs
      maternal_phenotype ~ e*maternal_prs
      offspring_phenotype ~ f*paternal_phenotype
      offspring_phenotype ~ g*maternal_phenotype
  
      # indirect effects 
      ia := i*a
      ha := h*a
      df := d*f
      eg := e*g
    
      # total effects 
      total_mum := c + (i*a) + (e*g)
      total_dad := b + (h*a) + (d*f)
    
      # covariance
      maternal_prs ~~ paternal_prs
      maternal_phenotype ~~ paternal_phenotype
      '

      ##################
      #ONE PARENT MODEL#
      ##################
      
      # Models where only one parent's data is used
      
      simple_parent1_model <- ' 
      
      #direct effects
      offspring_phenotype ~ c*maternal_prs         
      
      #mediator
      offspring_prs ~ i*maternal_prs
      offspring_phenotype ~ a*offspring_prs
      
      # indirect effects (i*a)
      ia := i*a
      
      # total effects 
      total_mum := c + (i*a)
      '
      
      extended_parent1_model <- '
      
      #direct effects
      offspring_phenotype ~ c*maternal_prs      
      
      #mediator
      offspring_prs ~ i*maternal_prs
      offspring_phenotype ~ a*offspring_prs
      maternal_phenotype ~ e*maternal_prs
      offspring_phenotype ~ g*maternal_phenotype
      
      # indirect effects 
      ia := i*a
      eg := e*g
      
      # total effects 
      total_mum := c + (i*a) + (e*g)
      '
      
 
# write.csv(sim_simple, paste0("sim_pa_noIGE_m1_h2", h2, "_tagged", tagged, "_prsnoise", prs_noise, ".csv"), row.names=T, quote=F)
# write.csv(sim_extended, paste0("sim_pa_noIGE_m2_h2", h2, "_tagged", tagged, "_prsnoise", prs_noise, ".csv"), row.names=T, quote=F)

```

## Simulations

### Parameter combinations
```{r params}
h2_params <- c(0.3, 0.6, 0.9)
tagged_params <- c(0.2, 0.6, 1)
prs_noise_params <- seq(0, 1, by = 0.1)
am_params <- seq(0, 0.2, by = 0.05)

params <- expand.grid(h2_params, tagged_params, prs_noise_params, am_params)
names(params) <- c("h2", "tagged", "prs_noise", "cor_AM")
params_list <- plyr::alply(params, 1, I)
```

### Simulate replicate datasets
```{r simulation, cache=TRUE, depends_on=c('data_sim', 'sim_regression', 'sim_path', 'params')}
replicates <- 100
model_sims <- parallel::mclapply(params_list, function(param) {
  sims <- list()
  for(i in 1:replicates) {
    cohort <- sim(param$h2, param$tagged, param$prs_noise, param$cor_AM)
    regression_result <- sim_regression(cohort)
    sem_simple_result <- sim_path(simple_model, cohort)
    sem_extended_result <- sim_path(extended_model, cohort)
    sem_simple_parent1_result <- sim_path(simple_parent1_model, cohort)
    sem_extended_parent1_result <- sim_path(extended_parent1_model, cohort)
    sims[[i]] <- list(replica = i,
                      params = param,
                      regression = regression_result,
                      sem_simple = sem_simple_result,
                      sem_extended = sem_extended_result,
                      sem_simple_parent1 = sem_simple_parent1_result,
                      sem_extended_parent1 = sem_extended_parent1_result)
  }
  return(sims)
},
mc.cores = 8)
```

Results tables
```{r results_tables, cache=TRUE, depends_on = c('simulation')}
library(dplyr)

model_sims_list <-  unlist(model_sims, recursive = FALSE)

sim_regression_results <- bind_rows(
  lapply(model_sims_list, function(sims) {
    coefs <- as_tibble(sims$regression$coefficients, rownames = "term") |>
      mutate(replicate = sims$replica)
    return(bind_cols(coefs, sims$params))
  })
) |>
rename(Predictor = term, SE = `Std. Error`,
       `T-value` = `t value`, `P-value` = `Pr(>|t|)`,
       Tagged = tagged) |>
mutate(across(h2:cor_AM, as.character))

sim_r2_results <- bind_rows(
  lapply(model_sims_list, function(sims) {
    mutate(sims$params, AdjR2 = sims$regression$adj.r.squared)
  })) |>
  rename(Tagged = tagged) |>
  mutate(across(h2:cor_AM, as.character))
  
sim_pathway_results <- bind_rows(
  lapply(model_sims_list, function(sims) {
    bind_rows(mutate(sims$sem_simple$pe, model = "simple"),
              mutate(sims$sem_extended$pe, model = "extended"),
              mutate(sims$sem_simple_parent1$pe, model = "simple p1"),
              mutate(sims$sem_extended_parent1$pe, model = "extended p1")) |>
    mutate(replicate = sims$replica) |>
    bind_cols(sims$params)
  })) |>
  select(DV = lhs, IV = rhs, label, Estimate = est, SE = se, `P-value` = pvalue,
         lowerCI = ci.lower, upperCI = ci.upper, model, replicate,
         h2, Tagged = tagged, prs_noise, cor_AM) |>
  mutate(across(h2:cor_AM, as.character))

```

## RESULT PLOTS  

### Regression Plots

```{r sim_noIGE_oprs}
library(ggplot2)

#offspring pgs estimates

df2 <- sim_regression_results |>
  filter(Predictor == "offspring_prs", cor_AM == "0")


image1 <- ggplot(data=df2, aes(x= prs_noise, y=Estimate, fill=Tagged)) +
  geom_boxplot(outlier.size=0) +
  scale_y_continuous(limits=c(0,1.1), breaks=seq(0.1,1, 0.1), expand = c(0, 0)) +
  xlab("Polygenic Score (PGS) Noise") + 
  ylab("Offspring Pheno ~ Offspring PGS (Beta Estimate)") +
  facet_grid(~h2) +
  theme(axis.text = element_text(size=10), strip.text = element_text(size=10), axis.title=element_text(size=10,face="bold")) +
  ggtitle("Extended Regression Model Offspring PGS Beta Estimate ") +
  scale_fill_manual(values = c("pink", "lightblue", "red"))
  
image1
```

```{r sim_noIGE_mprs}

#maternal pgs estimates

df2 <- sim_regression_results |>
  filter(Predictor == "maternal_prs", cor_AM == "0")

image2 <- ggplot(data=df2, aes(x= prs_noise, y=Estimate, fill=Tagged)) +
  geom_boxplot(outlier.size=0) +
  scale_y_continuous(limits=c(-0.5,0.5), breaks=seq(-0.5,0.5, 0.1), expand = c(0, 0)) +
  xlab("Polygenic Score (PGS) Noise") + 
  ylab("Offspring Pheno ~ Maternal PGS (Beta Estimate)") +
  facet_wrap(~h2) +
  theme(axis.text = element_text(size=10), strip.text = element_text(size=10), axis.title=element_text(size=10,face="bold")) +
  ggtitle("Extended Regression Model Maternal PGS Beta Estimate ") +
  scale_fill_manual(values = c("pink", "lightblue", "red"))
image2
```

```{r sim_noIGE_pprs}

#paternal pgs estimates

df2 <- sim_regression_results |>
filter(Predictor == "paternal_prs", cor_AM == "0")

image3 <- ggplot(data=df2, aes(x= prs_noise, y=Estimate, fill=Tagged)) +
  geom_boxplot(outlier.size=0) +
  scale_y_continuous(limits=c(-0.5,0.5), breaks=seq(-0.5,0.5, 0.1), expand = c(0, 0)) +
  xlab("Polygenic Score (PGS) Noise") + 
  ylab("Offspring Pheno ~ Paternal PGS (Beta Estimate)") +
  facet_wrap(~h2) +
  theme(axis.text = element_text(size=10), strip.text = element_text(size=10), axis.title=element_text(size=10,face="bold")) +
  ggtitle("Extended Regression Model Paternal PGS Beta Estimate ") +
  scale_fill_manual(values = c("pink", "lightblue", "red"))
image3
```

```{r sim_noIGE_mpheno}

#maternal pheno estimates

df2 <- sim_regression_results |>
  filter(Predictor == "maternal_phenotype", cor_AM == "0")

image5 <- ggplot(data=df2, aes(x= prs_noise, y=Estimate, fill=Tagged)) +
  geom_boxplot(outlier.size=0) +
  scale_y_continuous(limits=c(-0.2,0.5), breaks=seq(-0.2,0.5, 0.1), expand = c(0, 0)) +
  xlab("Polygenic Score (PGS) Noise") + 
  ylab("Offspring Pheno ~ Maternal Pheno (Beta Estimate)") +
  facet_wrap(~h2) +
  theme(axis.text = element_text(size=10), strip.text = element_text(size=10), axis.title=element_text(size=10,face="bold")) +
  ggtitle("Extended Regression Model Maternal Pheno Beta Estimate ") +
  scale_fill_manual(values = c("pink", "lightblue", "red"))
image5
```

```{r sim_noIGE_ppheno}

#paternal pheno estimates

df2 <- sim_regression_results |>
  filter(Predictor == "paternal_phenotype", cor_AM == "0")

image6 <- ggplot(data=df2, aes(x= prs_noise, y=Estimate, fill=Tagged)) +
  geom_boxplot(outlier.size=0) +
  scale_y_continuous(limits=c(-0.2,0.5), breaks=seq(-0.2,0.5, 0.1), expand = c(0, 0)) +
  xlab("Polygenic Score (PGS) Noise") + 
  ylab("Offspring Pheno ~ Paternal Pheno (Beta Estimate)") +
  facet_wrap(~h2) +
  theme(axis.text = element_text(size=10), strip.text = element_text(size=10), axis.title=element_text(size=10,face="bold")) +
  ggtitle("Extended Regression Model Paternal Pheno Beta Estimate ") +
  scale_fill_manual(values = c("pink", "lightblue", "red"))
image6
```

```{r sim_noIGE_adjR2, eval=FALSE}

#Adjusted R2

df2 <- sim_r2_results |>
  filter(cor_AM == 0)

image7 <- ggplot(data=df2, aes(x= prs_noise, y=AdjR2, fill=Tagged)) +
  geom_boxplot(outlier.size=0) +
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), expand = c(0, 0)) +
  xlab("Polygenic Score (PGS) Noise") + 
  ylab("Simulated Full Regression Model Accounted Variance") +
  facet_wrap(~h2) +
  theme(axis.text = element_text(size=10), strip.text = element_text(size=10), axis.title=element_text(size=10,face="bold")) +
  ggtitle("Extended Regression Model Adjusted R2 ") +
  scale_fill_manual(values = c("pink", "lightblue", "red"))
image7

```

### Pathway Plots 

```{r sim_mIGE_pathc}  

#here we are interested in labels c and f; the parental genetic nurturing pathways i.e. effect of parent prs on offpsring prs THAT DOES NOT GO through the offsprings own PRS or the parent pheno

#maternal genetic nurturing

df2 <- sim_pathway_results |>
  filter(label == "c", model == "extended", cor_AM == 0)

plot1 <- ggplot(data=df2, aes(x=prs_noise, y=Estimate, fill=Tagged)) + 
         geom_boxplot(outlier.size=0, fatten=1) + 
         scale_y_continuous(limits=c(-0.5,0.05), breaks=seq(-0.5,0.05, 0.1), expand = c(0, 0)) +
         xlab("Polygenic Score (PGS) Noise") + 
         ylab("Offspring Pheno ~ Maternal PGS Beta Estimate") +
         facet_wrap(~h2) +
         ggtitle("Extended Model Maternal Indirect Genetic Effect (Path C)") +
         scale_fill_brewer("Tagged Genetic Variance", palette="Accent") + 
         theme_bw() + 
         theme(axis.title = element_text(size=15), axis.text = element_text(size=15), strip.text = element_text(size=15), legend.title = element_text(size=15), legend.text = element_text(size=15), axis.text.x=element_text(angle=45))
plot1
#ggsave(file="sim_mIGE_pathc.png", plot=plot1, width=15, height=6)
#ggsave(file="sim_mIGE_pathc.svg", plot=plot1, width=15, height=6)

```

```{r sim_pIGE_pathf} 

#paternal genetic nurturing

df3 <- sim_pathway_results |>
  filter(label == "b", model == "extended", cor_AM == 0)

plot2 <- ggplot(data=df3, aes(x=prs_noise, y=Estimate, fill=Tagged)) +
         geom_boxplot(outlier.size=0, fatten=1) +
         scale_y_continuous(limits=c(-0.5,0.05), breaks=seq(-0.5,0.05, 0.1), expand = c(0, 0)) +
         xlab("Polygenic Score (PGS) Noise") + 
         ylab("Offspring Pheno ~ Paternal PGS Beta Estimate") +
         facet_wrap(~h2) +
         ggtitle("Extended Model Paternal Indirect Genetic Effect (Path F)") +
         scale_fill_brewer("Tagged Genetic Variance", palette="Accent") + 
         theme_bw() + 
         theme(axis.title = element_text(size=15), axis.text = element_text(size=15), strip.text = element_text(size=15), legend.title = element_text(size=15), legend.text = element_text(size=15), axis.text.x=element_text(angle=45))
plot2
# ggsave(file="sim_pIGE_pathf.png", plot=plot2, width=15, height=6)
# ggsave(file="sim_pIGE_pathf.svg", plot=plot2, width=15, height=6)

```

```{r sim_mIGE_pathj} 

#maternal pheno

df4 <- sim_pathway_results |>
  filter(label == "g", model == "extended", cor_AM == 0)

plot3 <- ggplot(data=df4, aes(x=prs_noise, y=Estimate, fill=Tagged)) +
         geom_boxplot(outlier.size=0, fatten=1) +
         scale_y_continuous(limits=c(-0.1,0.5), breaks=seq(-0.1,0.5, 0.1), expand = c(0, 0)) +
         xlab("Polygenic Score (PGS) Noise") + 
         ylab("Offspring Pheno ~ Maternal Pheno Beta Estimate") +
         facet_wrap(~h2) +
         ggtitle("Extended Model Offspring Pheno ~ Maternal Pheno Effect Beta Estimate (Path J)") +
         scale_fill_brewer("Tagged Genetic Variance", palette="Accent") + 
         theme_bw() + 
         theme(axis.title = element_text(size=15), axis.text = element_text(size=15), strip.text = element_text(size=15), legend.title = element_text(size=15), legend.text = element_text(size=15), axis.text.x=element_text(angle=45))

# ggsave(file="sim_mIGE_pathj.png", plot=plot3, width=15, height=6)
# ggsave(file="sim_mIGE_pathj.svg", plot=plot3, width=15, height=6)

```

```{r sim_pIGE_pathi} 

#paternal pheno

df5 <- sim_pathway_results |>
  filter(label == "f", model == "extended", cor_AM == 0)

plot4 <- ggplot(data=df5, aes(x=prs_noise, y=Estimate, fill=Tagged)) +
         geom_boxplot(outlier.size=0, fatten=1) +
         scale_y_continuous(limits=c(-0.1,0.5), breaks=seq(-0.1,0.5, 0.1), expand = c(0, 0)) +
         xlab("Polygenic Score (PGS) Noise") + 
         ylab("Offspring Pheno ~ Paternal Pheno Beta Estimate") +
         facet_wrap(~h2) +
         ggtitle("Extended Model Offspring Pheno ~ Paternal Pheno Effect Beta Estimate (Path I)") +
         scale_fill_brewer("Tagged Genetic Variance", palette="Accent") + 
         theme_bw() + 
         theme(axis.title = element_text(size=15), axis.text = element_text(size=15), strip.text = element_text(size=15), legend.title = element_text(size=15), legend.text = element_text(size=15), axis.text.x=element_text(angle=45))

# ggsave(file="sim_pIGE_pathi.png", plot=plot4, width=15, height=6)
# ggsave(file="sim_pIGE_pathi.svg", plot=plot4, width=15, height=6)

```

```{r final_plot}

library(patchwork)

final_plot <- plot1 / plot3
final_plot

# ggsave(file="maternal_ige_plots.png", plot=final_plot, width=15, height=12)
# ggsave(file="maternal_ige_plots.svg", plot=final_plot, width=15, height=12)

```

### Assortative mating

```{r sim_ige_am}

sim_pathway_am_results <- sim_pathway_results |>
  filter(h2 == "0.6", prs_noise == "0") |>
  filter(model %in% c("simple p1", "extended p1"), label %in% c("a", "b", "c", "d", "e", "f", "g", "h", "i")) |>
  mutate(Model = case_match(model, "simple p1" ~ "Simple Model", "extended p1" ~ "Extended Model"))
  
sim_pathway_exp <- c("a" = 1, "b" = 0, "c" = 0,
                        "d" = 1, "e" = 1, "f" = 0, "g" = 0,
                        "h" = 0.5, "i" = 0.5)
                        
sim_pathway_am_exp <-
  tibble(label = names(sim_pathway_exp),
         Estimate = as.vector(sim_pathway_exp)) |>
  filter(label %in% sim_pathway_am_results$label)     
  
ggplot(sim_pathway_am_results, aes(x = cor_AM, y = Estimate, fill = Tagged)) +
  geom_hline(data = sim_pathway_am_exp, aes(yintercept = Estimate), col = 'blue') +
  geom_boxplot(outlier.size = 0, fatten = 1) +
  facet_grid(cols = vars(label), rows = vars(Model)) +
  ggtitle("Simulation results: Assortative mating") +
  scale_x_discrete("Assortative mating correlation") +
  scale_y_continuous("Path estimate") +
  scale_fill_brewer("Tagged Genetic Variance", palette="Accent") +
  theme_bw()

```